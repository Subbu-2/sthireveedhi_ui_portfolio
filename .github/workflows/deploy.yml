name: Build & Deploy Portfolio UI

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute short SHA
        id: vars
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build & Push UI image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            VITE_APP_VERSION=${{ steps.vars.outputs.sha }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/sthireveedhi-portfolio-ui:${{ steps.vars.outputs.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/sthireveedhi-portfolio-ui:latest

      - name: Deploy to EC2 via SSH (docker compose)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            APP_DIR=/opt/sthireveedhi-portfolio
            UI_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/sthireveedhi-portfolio-ui:${{ steps.vars.outputs.sha }}"
            UI_PORT=8086

            sudo mkdir -p $APP_DIR
            sudo chown $USER:$USER $APP_DIR
            cd $APP_DIR

            # write docker-compose.yml (single source of truth)
            cat > docker-compose.yml << EOF
            services:
              ui:
                image: ${UI_IMAGE}
                container_name: sthireveedhi-portfolio-ui
                ports:
                  - "127.0.0.1:${UI_PORT}:80"
                restart: unless-stopped
            EOF

            # pull + restart
            docker compose pull
            docker compose up -d

            # verify
            docker ps --filter "name=sthireveedhi-portfolio-ui"

            # cleanup: remove unused images safely (does NOT remove running image)
            docker image prune -af --filter "until=168h" || true
            docker builder prune -af --filter "until=168h" || true

            # optional: show disk
            df -h | head -n 20